# For Taurus:
#    make -B SPARK_ROOT=~/spark-1.5.2-bin-hadoop2.6 SPARK_JAR=~/spark-1.5.2-bin-hadoop2.6/lib/spark-assembly-1.5.2-hadoop2.6.0.jar SCALA_ROOT=$(dirname $(which scala))/../lib

ROOTBEER_ROOT := ../../../../rootbeer1
SPARK_ROOT    := /opt/spark-1.5.2
SCALA_ROOT    := /usr/share/java
SCALAC        := scalac
JAVAC         := javac

ROOTBEER_JAR   = $(ROOTBEER_ROOT)/Rootbeer.jar
SCALA_JAR      = $(SCALA_ROOT)/scala-library.jar
SPARK_JAR      = $(SPARK_ROOT)/core/target/spark-core_2.10-1.5.2.jar

.phony: clean all

all: MontePi.jar
run: MontePi.jar
	$(SPARK_ROOT)/bin/spark-submit --master local[1] --class TestMonteCarloPi $< 268435456 1
clean:
	rm -f *.class *.jar


MonteCarloPiKernel.class: MonteCarloPiKernel.java $(ROOTBEER_JAR)
	javac $< -classpath $(ROOTBEER_JAR):.

gpu.jar: MonteCarloPiKernel.class
	jar -cvf gputmp.jar $^
	java -jar $(ROOTBEER_JAR) gputmp.jar $@ -64bit -computecapability=sm_30


Distribute.class: Distribute.scala
	$(SCALAC) $< -deprecation

MonteCarloPi.class: MonteCarloPi.scala Distribute.class gpu.jar $(ROOTBEER_JAR)
	$(SCALAC) $< -deprecation -classpath $(SPARK_JAR):$(ROOTBEER_JAR):gpu.jar:.

TestMonteCarloPi.class: TestMonteCarloPi.scala MonteCarloPi.class gpu.jar Distribute.class
	$(SCALAC) $< -classpath $(ROOTBEER_JAR):$(HADOOP_JAR):$(SPARK_JAR):gpu.jar:. -deprecation

# note that manifest.txt must be at the first position
cpu.jar: manifest.txt TestMonteCarloPi.class MonteCarloPi.class Distribute.class
	# Note that \$$ -> \$ by Makefile and \$ -> $ by interpreting shell
	# These files are necessary scala autogenerated files for anonymous classes
	jar -cvfm $@ $^ TestMonteCarloPi\$$*.class MonteCarloPi\$$*.class Distribute\$$*.class

# note that gpu.jar must come before cpu.jar because of manifest.txt overwriting
# Spark Jar is not merged, because it is submitted via spark submit scripts (and it would bloat jar + 150MB)
MontePi.jar: $(SCALA_JAR) $(ROOTBEER_JAR) gpu.jar cpu.jar
	zipmerge $@ $^

# scalac TestMonteCarloPi.scala -classpath ../../../../rootbeer1/Rootbeer.jar:/home/s3495379/spark-1.5.2-bin-hadoop2.6/assembly/target/scala-2.10/spark-assembly-1.5.2-hadoop2.2.0.jar::gpu.jar:. -deprecation
